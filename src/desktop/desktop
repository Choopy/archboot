#!/bin/bash

_install_desktop() {

    # Intel Microcode
    lscpu | grep "Intel" >/dev/null 2>&1
    if [[ $? -eq 0 ]]
    then
        _info "Installing Intel CPU Microcode"
        _chroot "pacman --noconfirm -S $_intel"
    fi

    # GPU Driver
    _info "Installing VGA Driver"
    _chroot "pacman --noconfirm -S $GPU_driver"

    # File System
    _info "Installing File System"
    _chroot "pacman --noconfirm -S $_file_system"

    # Desktop Environment
    _info "Installing $desktop"
    if [[ ${desktop} == "xfce" ]]
    then

        # XFCE
        _chroot "pacman --noconfirm -S $_xfce"

        # LXDM
        _info "Installing lxdm"
        _chroot "pacman --noconfirm -S $_lxdm"

    elif [[ ${desktop} == "kde" ]]
    then

        # KDE
        _chroot "pacman --noconfirm -S $_kde"

        # SDDM
        _info "Installing sddm"
        _chroot "pacman --noconfirm -S $_sddm"

    elif [[ ${desktop} == "gnome" ]]
    then

        # GNOME
        _chroot "pacman --noconfirm -S $_gnome"

    else

        # LXDE
        _chroot "pacman --noconfirm -S $_lxde"
    fi

    # Additional apps
    if [[ ! -z ${additional_apps+x} ]]
    then

        # Firefox
        _info "Installing Firefox"
        _chroot "pacman --noconfirm -S $_firefox"

        # Flash
        _info "Installing Flash"
        _chroot "pacman --noconfirm -S $_flash"

        # Java
        _info "Installing Java"
        _chroot "pacman --noconfirm -S $_java"

        # Libreoffice
        _info "Installing Libreoffice"
        _chroot "pacman --noconfirm -S $_libreoffice"

        # Gimp
        _info "Installing Gimp"
        _chroot "pacman --noconfirm -S $_gimp"

        # Cups
        _info "Installing Cups"
        _chroot "pacman --noconfirm -S $_cups
        systemctl enable org.cups.cupsd"

        # Sane
        _info "Installing Sane"
        _chroot "pacman --noconfirm -S $_sane"
    fi

    # XFCE Packages
    if [[ ${desktop} == "xfce" ]]
    then

        # Docky
         _info "Installing Docky"
        _chroot "pacman --noconfirm -S $_docky"

        # Fonts
        _info "Installing Fonts"
        _chroot "pacman --noconfirm -S $_fonts"

         # Multimedia
        _info "Installing Multimedia"
        _chroot "pacman --noconfirm -S $_multimedia"

        # Accessories
        _info "Installing Accessories"
        _chroot "pacman --noconfirm -S $_accessories"

        # Network Applet
        _info "Installing Network Applet"
        _chroot "pacman --noconfirm -S $_network_applet"
    fi
}

_desktop_settings() {

    # Keyboard layout
    _info "Setting keyboard layout"
    _chroot "wget $_url/conf/00-keyboard.conf
    mv 00-keyboard.conf /etc/X11/xorg.conf.d/"


    # Display Manager
    if [[ ${desktop} == "xfce" || ${desktop} == "lxde" ]]
    then

        # XFCE or LXDE > LXDM
        _info "Enabling LXDM"
        _chroot "wget $_url/conf/lxdm_$desktop.conf
        rm /etc/lxdm/lxdm.conf
        mv lxdm_$desktop.conf /etc/lxdm/lxdm.conf
        systemctl enable lxdm"

    elif [[ ${desktop} == "gnome" ]]
    then

        # GNOME > GDM
        _info "Enabling GDM"
        _chroot "systemctl enable gdm"

    elif [[ ${desktop} == "kde" ]]
    then

        # KDE > SDDM
        _info "Enabling SDDM"
        _chroot "sed -i -e 's/Numlock=none/Numlock=on/g' /etc/sddm.conf
        setfacl -m u:sddm:x /home/${USER_name}
        systemctl enable sddm"
    fi

    # Themes & icons
    if [[ ${desktop} == "xfce" || ${desktop} == "gnome" ]]
    then
        _info "Adding some themes & icons"
        _chroot "wget $_url/data/$desktop.tar.xz
        tar xf $desktop.tar.xz -C /home/$USER_name/ > /dev/null 2>&1
        rm $desktop.tar.xz"
    fi

    # Groups
    _info "Add ${USER_name} to all groups"
    group_list=$(cut -d: -f1 /mnt/etc/group)
    for group in $group_list
    do
        _chroot "usermod -aG $group $USER_name"
    done
}
