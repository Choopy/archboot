#!/bin/bash

#                             BOOTLOADER
# ============================================================================
# Here we install and configure bootloader, systemd-boot for UEFI firmware
# and Grub2 for BIOS firmware.
#
# All steps are described in the official documentation:
#
#     UEFI...: https://wiki.archlinux.org/index.php/Systemd-boot
#     BIOS...: https://wiki.archlinux.org/index.php/GRUB
#
# BIOS only: install of  additional themes for beautifull OS selection menu.
# ============================================================================

_install_bootloader() {

    # UEFI Firmware - systemd-boot
    if [[ ${FIRMWARE} == "UEFI" ]]; then
        _info "Installing systemd-boot on ${BOOT_PARTITION}"
       _chroot "bootctl --path=\"/boot/efi/\" install"

    # BIOS Firmware - GRUB2
    else

        # Install bootloader packages
        _info "Installing bootloader packages"
        _chroot "pacman --noconfirm -S ${BOOTAPPS}"

        # Install Grub2
        _info "Installing Grub2 bootloader on ${DRIVE}"
        _chroot "grub-install --target=i386-pc ${DRIVE}"

        # Download Grub2 Themes
        _info "Downloading Grub2 Themes"
        _wget ${GHPAGES}/assets/images/background.png
        _chroot "git clone git://github.com/Generator/Grub2-themes.git"
        echo

        # Install Grub2 Themes
        _info "Installing Grub2 Themes"
        _chroot "cp -r Grub2-themes/{Archlinux,Archxion} /boot/grub/themes/"
        sed -i -e "s/GRUB_GFXMODE=auto/GRUB_GFXMODE=1024x768/g" \
/mnt/etc/default/grub
        echo "GRUB_THEME=/boot/grub/themes/Archlinux/theme.txt" \
>> /mnt/etc/default/grub
        echo "desktop-image: \"background.png\"" \
>> /mnt/boot/grub/themes/Archlinux/theme.txt
        mv background.png /mnt/boot/grub/themes/Archlinux/
        rm -r /mnt/Grub2-themes

        # Config Grub2
        _info "Configuring Grub2 bootloader"
        _chroot "grub-mkconfig -o /boot/grub/grub.cfg"
    fi
}

# archboot by grm34 under Apache License 2.0
# ============================================================================
