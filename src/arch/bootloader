#!/bin/bash

#                             BOOTLOADER
# ============================================================================
# Here we install and configure bootloader, systemd-boot for UEFI and
# Grub2 (with additional themes for beautifull OS selection menu) for BIOS.
#
# All steps are described in the official documentation:
#
#   UEFI...: https://wiki.archlinux.org/index.php/Systemd-boot
#   BIOS...: https://wiki.archlinux.org/index.php/GRUB
# ============================================================================

_install_bootloader() {

    # UEFI Firmware > systemd-boot
    if [[ ${FIRMWARE} == "UEFI" ]]; then
        _info "Installing systemd-boot on ${BOOT_PARTITION}"
        _chroot "_check bootctl --path=/boot install"

        # Replace loader.conf
        _check mv -v /mnt/boot/loader/loader.conf \
/mnt/boot/loader/loader.backup
        _check cp -v loader.conf /mnt/boot/loader/

        # Create new boot entry
        BOOTCONF="/mnt/boot/loader/entries/arch.conf"
        _check echo "title Arch Linux" > ${BOOTCONF}
        _check echo "linux /vmlinuz-${KERNEL_NAME,,}" >> ${BOOTCONF}
        case ${MICROCODE} in
            intel|amd)
                _check echo "initrd /${MICROCODE}-ucode.img" >> ${BOOTCONF}
                ;;
        esac
        _check echo "initrd /initramfs-${KERNEL_NAME,,}.img" >> ${BOOTCONF}
        _check echo "options root=${SYSTEM_PARTITION} quiet splash rw" \
>> ${BOOTCONF}

        # Update bootloader
        _chroot "_check bootctl --path=/boot update"

    # BIOS Firmware > Grub2
    else

        # Install Grub2
        _info "Installing Grub bootloader"
        _chroot "_install ${GRUB}"
        _chroot "_check grub-install --target=i386-pc ${DRIVE}"

        # Download Themes
        _info "Downloading Grub Themes"
        _wget ${GHPAGES}/assets/images/background.png
        _chroot "_check git clone git://github.com/Generator/Grub2-themes.git"
        echo

        # Install Themes
        _info "Installing Grub Themes"
        _check cp -rv /mnt/Grub2-themes/{Archlinux,Archxion} \
/mnt/boot/grub/themes/
        _check sed -i -e "s/GRUB_GFXMODE=auto/GRUB_GFXMODE=1024x768/g" \
/mnt/etc/default/grub
        _check echo "GRUB_THEME=/boot/grub/themes/Archlinux/theme.txt" \
>> /mnt/etc/default/grub
        _check echo "desktop-image: \"background.png\"" \
>> /mnt/boot/grub/themes/Archlinux/theme.txt
        _check mv -v background.png /mnt/boot/grub/themes/Archlinux/
        _check rm -rv /mnt/Grub2-themes

        # Configure Grub2
        _info "Configuring Grub bootloader"
        _chroot "_check grub-mkconfig -o /boot/grub/grub.cfg"
    fi
}

# archboot by grm34 under Apache License 2.0
# ============================================================================
