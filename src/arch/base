#!/bin/bash

_base() {

    # Install Base System
    _info "Installing base system"
    yes '' | pacstrap /mnt ${_arch}

    # Setting fstab
    _info "Setting fstab"
    genfstab -U -p /mnt >> /mnt/etc/fstab

    # Setting TimeZone
    _info "Setting TimeZone"
    ln -sf /usr/share/zoneinfo/${timezone} /mnt/etc/localtime

    # Setting locale
    _info "Setting and generating locale"
    echo "${language}.UTF-8 UTF-8" >> /mnt/etc/locale.gen
    _chroot "locale-gen
    export LANG=${language}.UTF-8"
    echo "LANG=${language}.UTF-8" > /mnt/etc/locale.conf

    # Setting keyboard
    _info "Setting keyboard"
    echo "KEYMAP=${keymap_code}" > /mnt/etc/vconsole.conf

    # Setting hostname
    _info "Setting hostname"
    echo "${HOST_name}" > /mnt/etc/hostname

    # Setting Linux
    _info "Setting Linux environment"
    _chroot "mkinitcpio -p linux"

    # Setting root passwd
    _info "Setting root password"
    _chroot "echo 'root:${ROOT_passwd}' | chpasswd"

    # Setting pacman
    _info "Setting pacman"
    wget ${_url}/conf/pacman.conf
    mv pacman.conf /mnt/etc/pacman.conf
    if [[ ! -z ${multilib+x} ]]; then
        _chroot "sed -i -e 's/#MULTI //g' /etc/pacman.conf"
    fi

    # Install yaourt
    if [[ ! -z ${aur+x} ]]; then
        _info "Installing yaourt"
        sed -i -e "s/#AUR //g" /mnt/etc/pacman.conf
        _chroot "pacman --noconfirm -Syu ${_yaourtapps}"
    fi

    # Install Network
    _info "Installing network"
    _chroot "pacman --noconfirm -S ${_netapps}
    systemctl enable NetworkManager"

    # Install Intel Microcode
    lscpu | grep "Intel" >/dev/null 2>&1
    if [[ $? -eq 0 ]]; then
        _info "Installing Intel CPU Microcode"
        _chroot "pacman --noconfirm -S ${_intel}"
    fi

    # Install required packages
    _info "Installing required packages"
    _chroot "pacman --noconfirm -S ${_requiredapps}"

    # Setting Reflector
    _info "Setting reflector service"
    wget ${_url}/conf/reflector.service
    mv reflector.service /mnt/etc/systemd/system/reflector.service
    _chroot "systemctl enable reflector.service"

    # Setting user
    _info "Setting ${USER_name}"
    _chroot "useradd -g users -m -s /bin/bash ${USER_name}
    echo '${USER_name}:${USER_passwd}' | chpasswd"
    if [[ ! -z ${power+x} ]]; then
        echo "${USER_name} ALL=(ALL) ALL" >> /mnt/etc/sudoers
    fi
}
